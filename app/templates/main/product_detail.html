{% extends 'base.html' %}
{% block title %}{{ product.name }} | Farmer's Market Hub{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-6">
            <!-- Product Image -->
            <div class="flex justify-center">
                {% if product.image %}
                <img src="{{ url_for('static', filename='uploads/' + product.image) }}" alt="{{ product.name }}" class="max-w-full h-96 object-cover rounded-lg">
                {% else %}
                <div class="w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center">
                    <span class="text-gray-500 text-lg">No Image Available</span>
                </div>
                {% endif %}
            </div>

            <!-- Product Details -->
            <div class="space-y-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ product.name }}</h1>
                    <p class="text-lg text-green-600 font-semibold mt-2">₹{{ "%.2f"|format(product.price) }} per {{ product.unit }}</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Description</h3>
                        <p class="text-gray-600">{{ product.description or 'No description available.' }}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Category</span>
                            <p class="text-gray-900">{{ product.category.title() }}</p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Available Stock</span>
                            <p class="text-gray-900">{{ product.quantity }} {{ product.unit }}</p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Farmer</span>
                            <p class="text-gray-900">{{ product.farmer.username }}</p>
                        </div>
                        {% if product.organic %}
                        <div>
                            <span class="text-sm font-medium text-gray-500">Certification</span>
                            <p class="text-green-600 font-medium">Organic</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Add to Cart Form -->
                {% if current_user.is_authenticated %}
                <form id="add-to-cart-form" action="{{ url_for('orders.add_to_cart', product_id=product.id) }}" method="post" class="mt-4 flex items-center gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="flex items-center border border-gray-300 rounded-md">
                        <button type="button" id="decrease-quantity" class="px-3 py-2 text-gray-600 hover:text-gray-800 focus:outline-none">-</button>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.quantity }}" aria-label="Quantity" class="w-16 text-center border-0 focus:ring-0">
                        <button type="button" id="increase-quantity" class="px-3 py-2 text-gray-600 hover:text-gray-800 focus:outline-none">+</button>
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 font-medium">
                        Add to Cart
                    </button>
                </form>
                {% else %}
                <div class="mt-4">
                    <a href="{{ url_for('auth.login') }}" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 font-medium">
                        Login to Purchase
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if related_products %}
<div class="mt-12">
    <h2 class="text-xl font-semibold mb-4">More from {{ product.farmer.username }}</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
        {% for rel in related_products %}
            <div class="product-card bg-white rounded-lg shadow p-4 flex flex-col">
                <a href="{{ url_for('main.product_detail', product_id=rel.id) }}">
                    {% if rel.image %}
                    <img src="{{ url_for('static', filename='uploads/' + rel.image) }}" alt="{{ rel.name }}" class="w-full h-32 object-cover rounded mb-2">
                    {% else %}
                    <div class="w-full h-32 bg-gray-200 rounded mb-2 flex items-center justify-center">
                        <span class="text-gray-500 text-sm">No Image</span>
                    </div>
                    {% endif %}
                    <h3 class="text-lg font-bold">{{ rel.name }}</h3>
                </a>
                <p class="text-green-700 font-semibold mt-1 mb-2">₹{{ '%.2f'|format(rel.price) }}</p>
                <div class="flex-1"></div>
                <a href="{{ url_for('main.product_detail', product_id=rel.id) }}" class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-center">View</a>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    const decreaseBtn = document.getElementById('decrease-quantity');
    const increaseBtn = document.getElementById('increase-quantity');
    const addToCartForm = document.getElementById('add-to-cart-form');
    
    if (decreaseBtn && increaseBtn && quantityInput) {
        decreaseBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });
        
        increaseBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            const maxValue = parseInt(quantityInput.max);
            if (currentValue < maxValue) {
                quantityInput.value = currentValue + 1;
            }
        });
    }
    
    // Handle form submission with AJAX
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrf_token')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-lg z-50';
                    message.textContent = data.message;
                    document.body.appendChild(message);
                    
                    // Update cart count in navigation
                    const cartCount = document.getElementById('cart-count');
                    if (cartCount) {
                        cartCount.textContent = data.cart_count;
                        cartCount.style.display = data.cart_count > 0 ? 'flex' : 'none';
                    }
                    
                    // Remove message after 3 seconds
                    setTimeout(() => {
                        message.remove();
                    }, 3000);
                } else {
                    // Show error message
                    const message = document.createElement('div');
                    message.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-md shadow-lg z-50';
                    message.textContent = data.message;
                    document.body.appendChild(message);
                    
                    setTimeout(() => {
                        message.remove();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const message = document.createElement('div');
                message.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-md shadow-lg z-50';
                message.textContent = 'An error occurred. Please try again.';
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 3000);
            })
            .finally(() => {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }
});
</script>
{% endblock %} 